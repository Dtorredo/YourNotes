var ie=Object.defineProperty;var se=(e,t,o)=>t in e?ie(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;var b=(e,t,o)=>se(e,typeof t!="symbol"?t+"":t,o);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const c of i.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&a(c)}).observe(document,{childList:!0,subtree:!0});function o(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(n){if(n.ep)return;n.ep=!0;const i=o(n);fetch(n.href,i)}})();const d=window.firebase;d.auth();d.database();class re{constructor(t,o,a){b(this,"noteId");b(this,"firebaseDatabase");b(this,"currentUser");b(this,"content");b(this,"ws");this.noteId=t,this.firebaseDatabase=o,this.currentUser=a,this.content="",this.ws=null}async init(t){let o=!1;const a=()=>{if(o)return;const c=t.selectionStart;t.value=this.content,t.setSelectionRange(c,c)};t.addEventListener("input",()=>{o=!0;const c=t.value;this.content=c,this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify({type:"content",noteId:this.noteId,content:c,userId:this.currentUser&&this.currentUser.uid})),o=!1});const n=window.location.protocol==="https:"?"wss:":"ws:",i=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"?"ws://localhost:4000":`${n}//${window.location.host}`;return this.ws=new WebSocket(i),this.ws.onopen=()=>{var c;(c=this.ws)==null||c.send(JSON.stringify({type:"join",noteId:this.noteId,userId:this.currentUser&&this.currentUser.uid}))},this.ws.onmessage=c=>{try{const u=JSON.parse(c.data);u.type==="content"&&u.noteId===this.noteId&&(o=!0,this.content=u.content||"",a(),o=!1)}catch(u){console.error("WS collab message error:",u)}},this}setContent(t){this.content=t||""}getContent(){return this.content||""}destroy(){this.ws&&this.ws.close()}}const I=e=>`${window.location.origin+window.location.pathname}?note=${e}`,T=()=>new URLSearchParams(window.location.search).get("note");window.getNoteIdFromUrl=T;window.getShareableLink=I;let w=null,C=null;const ae=(e,t)=>{w=e,C=t};let N,h=null,m=null,l={};const B={"_new note":{content:""}},s={title:Object.keys(B)[0],isCollaborative:!1,noteId:null,lockedTitle:!1},z=()=>"note_"+Date.now()+"_"+Math.random().toString(36).substr(2,9);window.generateNoteId=z;const le={apiKey:"AIzaSyBV-GHwBk1Bibx9xolT7IdvsQ8mjgO-fkU",authDomain:"notes-uno.firebaseapp.com",databaseURL:"https://notes-uno-default-rtdb.firebaseio.com",projectId:"notes-uno",storageBucket:"notes-uno.firebasestorage.app",messagingSenderId:"1025777646528",appId:"1:1025777646528:web:2f6bc79f92a5ca04256625",measurementId:"G-G17GF41EWB"};var G,H,J;if(d&&!((G=d.apps)!=null&&G.length)&&!((J=(H=window.firebase)==null?void 0:H.apps)!=null&&J.length))try{d.initializeApp(le)}catch{}console.log("store.ts loaded");const q=new d.auth.GoogleAuthProvider;q.setCustomParameters({prompt:"select_account"});try{const e=d.auth();e&&typeof e.setPersistence=="function"&&e.setPersistence("local").catch(t=>console.warn("Persistence error",t))}catch(e){console.warn("Auth persistence not supported, continuing without it:",e)}d.auth().onAuthStateChanged(e=>{h=e||null,e?(de(e.uid),A(e)):A(null)});const A=e=>{let t=0;const o=50,a=()=>{const n=document.getElementById("user-profile-floating"),i=document.getElementById("user-profile-pic"),c=document.getElementById("user-logout-btn"),u=document.getElementById("user-name");if(!n||!i||!c||!u){t++,t<o?setTimeout(a,100):console.warn("Profile UI elements not found after retries");return}if(e){if(e.photoURL)i.src=e.photoURL,i.style.display="block",n.removeAttribute("data-initial");else{const D=(e.displayName||e.email||"U").charAt(0).toUpperCase();i.style.display="none",n.setAttribute("data-initial",D)}u.textContent=e.displayName||e.email||"Signed in",c.style.display="block",c.textContent="ðŸšª Logout",c.title=`Logout ${e.displayName||e.email}`,n.style.display="flex"}else i.style.display="none",n.removeAttribute("data-initial"),u.textContent="Not signed in",c.style.display="block",c.textContent="ðŸ” Login",c.title="Sign in with Google",n.removeAttribute("data-initial"),n.style.display="flex"};a()};window.addEventListener("load",()=>{setTimeout(()=>{h&&A(h)},1e3)});const ce=async()=>{if(!h){try{await d.auth().signInWithPopup(q)}catch(e){console.error("Login error:",e),e.code!=="auth/popup-closed-by-user"&&alert("Failed to login: "+e.message)}return}try{await d.auth().signOut(),h=null;const e=document.querySelector("textarea");e&&(e.value=""),window.location.reload()}catch(e){console.error("Logout error:",e),alert("Failed to logout: "+e.message)}},de=e=>{N=d.database().ref(`/${e}`),ue()},W=(e,t)=>{let o=Object.assign({},B),a=Object.keys(t);for(let n=0;n<a.length;n++){let i=a[n];e[i]&&e[i].modified>t[i].modified?o[i]=e[i]:o[i]=t[i]}return o},ue=()=>{fe().then(e=>{l=W(l,e),w&&w(l),x(l),ge(t=>{l=W(l,t),w&&w(l),x(l),l[s.title]&&C&&C(s.title)})})},U=e=>{N&&N.set({notes:e})},x=e=>{localStorage.setItem("notes",JSON.stringify(e))};window.persist=U;window.logoutUser=ce;const fe=()=>N.once("value").then(e=>e.val()?e.val().notes:{}),ge=e=>{N.on("value",t=>{t.val()&&e(t.val().notes)})},S=new Map,K=async(e,t)=>{if(!h)return console.error("User not authenticated"),null;if(m&&m.destroy(),S.has(e))return m=S.get(e),m;const o=new re(e,d.database(),h);return await o.init(t),S.set(e,o),m=o,o},pe=async(e,t="")=>{const o=z(),a=await K(o,e);return t&&typeof a.setContent=="function"&&a.setContent(t),he(o,me(t||"_new collaborative note")),o},he=(e,t)=>{d.database().ref(`collaborative-notes/${e}/metadata`).update({title:t,modified:Date.now()})},me=e=>e.split(`
`)[0].replace("#","");l=Object.assign({},B,JSON.parse(localStorage.getItem("notes")||"null"));const r=document.getElementsByTagName("textarea")[0],_=document.getElementsByTagName("sidebar")[0],V=document.getElementsByTagName("list")[0],f=document.getElementsByTagName("toggle")[0],Q=document.getElementsByTagName("night")[0],g=document.getElementById("ai-selection-toolbar"),v=document.getElementById("ai-selection-prompt"),y=document.getElementById("ai-edit-toggle");let O=!1;console.log("ui.ts loaded");let p=null;const $=(e,t={})=>{let o="",a=Object.keys(e).sort();for(let i of a)o+=`<div class="note-item legacy" data-title="${i}" data-type="legacy">${i}</div>`;let n=Object.keys(t).sort((i,c)=>(t[c].modified||0)-(t[i].modified||0));for(let i of n){const u=t[i].title||"_untitled";o+=`<div class="note-item collaborative" data-note-id="${i}" data-type="collaborative">ðŸ‘¥ ${u}</div>`}V.innerHTML=o};V.addEventListener("click",e=>{const o=e.target.closest(".note-item");if(o){const a=o.getAttribute("data-type");if(a==="legacy"){const n=o.getAttribute("data-title");n&&F(n)}else if(a==="collaborative"){const n=o.getAttribute("data-note-id");n&&ye(n)}}});const ye=async e=>{await j(e)};function X(){const e=document.getElementById("share-btn");e&&(s.isCollaborative?e.style.display="block":e.style.display="none")}const F=e=>{s.title=e,s.isCollaborative=!1,s.noteId=null,s.lockedTitle=!!(l[e]&&l[e].lockedTitle),m&&m.destroy(),r.value=l[e].content,k||R(),r.focus(),r.removeEventListener("keyup",E),r.addEventListener("keyup",E),X()},j=async e=>{s.isCollaborative=!0,s.noteId=e,s.lockedTitle=!1;const t=`${window.location.origin}${window.location.pathname}?note=${e}`;window.history.pushState({noteId:e},"",t),r.removeEventListener("keyup",E);try{await K(e,r)}catch(o){console.error("Error loading collaborative note:",o),alert("Failed to load collaborative note. Please try again.");return}k||R(),r.focus(),X()},Y=()=>{if(s.isCollaborative)return;const e=r.value,t=l[s.title],o=s.lockedTitle||t&&t.lockedTitle;let a=o?s.title:be(e)||s.title;if(s.title!=="_new note"&&l[s.title]&&delete l[s.title],e.trim()){s.title=a||"_new note";const n=new Date().getTime();l[s.title]={content:e,modified:n,lockedTitle:o},s.lockedTitle=o}else s.lockedTitle=!1;Z()},Z=()=>{x(l),typeof U=="function"&&U(l),$(l)},be=e=>e.split(`
`)[0].replace("#",""),we=e=>{let t;return(...o)=>{let a,n=()=>{t=null,e.apply(a,o)};clearTimeout(t),t=setTimeout(n,500)}};let k=!0;const R=()=>{_.style.display=_.style.display==="block"?"none":"block",r.style.display=r.style.display==="none"?"block":"none",k=!k,k?(f.innerHTML="â˜°â˜°",f.style.float="left",f.style.top="-20px",f.style.left="-7px",r.focus()):(f.innerHTML="âœ•",f.style.top="-7px",f.style.left="-20px",f.style.float="right")},ee=()=>{let e,t;localStorage.night?(e={backgroundColor:"#778873",color:"#EFEFEF"},t="â˜€ï¸"):(e={backgroundColor:"#EFEFEF",color:"#333"},t="ðŸŒš"),Object.assign(document.body.style,e),Object.assign(r.style,e),Q.innerHTML=t},ve=()=>{localStorage.night?delete localStorage.night:localStorage.night="true",ee()},E=we(Y);r.addEventListener("keyup",E);f.addEventListener("click",R);Q.addEventListener("click",ve);ee();let P=null;typeof T=="function"&&(P=T());P&&setTimeout(()=>{h&&j(P)},1e3);"serviceWorker"in navigator&&(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"?navigator.serviceWorker.getRegistrations().then(e=>e.forEach(t=>t.unregister())).catch(e=>console.warn("Failed to unregister service workers:",e)):navigator.serviceWorker.register("/sw.js",{scope:"/"}));const ke=async()=>{if(!h){alert("Please wait for authentication to complete");return}try{console.log("Creating new collaborative note...");const e=await pe(r,"");console.log("Note created with ID:",e),await j(e),console.log("Note rendered successfully");const t=document.getElementById("share-btn");if(t&&(t.style.display="block"),typeof I=="function"){const o=I(e);console.log("Share link:",o)}}catch(e){console.error("Error creating collaborative note:",e),alert("Failed to create collaborative note: "+e.message)}},Ie=()=>{if(!s.isCollaborative||!s.noteId){alert("Please select a collaborative note to share");return}let e;typeof I=="function"?e=I(s.noteId):e=`${window.location.origin+window.location.pathname}?note=${s.noteId}`,navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(e).then(()=>{alert(`âœ… Share link copied to clipboard!

`+e)}).catch(t=>{console.error("Clipboard error:",t),prompt("Share this link with collaborators:",e)}):prompt("Share this link with collaborators:",e)},M=()=>{if(!r)return;const e=r.selectionStart,t=r.selectionEnd;e!==t?(p={start:e,end:t},y&&y.classList.remove("disabled")):(p=null,y&&y.classList.add("disabled"),L())},L=()=>{g&&g.classList.add("hidden")},Ne=()=>{if(!(!y||!g)){if(!p||p.start===p.end){alert("Highlight some text first, then click the AI icon.");return}g.classList.contains("hidden")?(g.classList.remove("hidden"),v&&!v.value&&(v.value="Improve clarity but keep the meaning.")):L()}};y&&(y.classList.add("disabled"),y.addEventListener("click",Ne));const te=async e=>{const t=await fetch("/api/ai",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){const o=await t.text();throw new Error(o||"AI request failed")}return t.json()},Ee=async()=>{if(!p||p.start===p.end){alert("Please highlight the text you want to transform first.");return}const{start:e,end:t}=p,o=r.value.substring(e,t),a=v&&v.value.trim()||"Rewrite the selected text to improve clarity.";if(!o.trim()){alert("Selected text is empty.");return}try{g&&g.classList.add("loading");const{result:n}=await te({type:"edit",selection:o,prompt:a,content:r.value});if(!n){alert("AI did not return any changes.");return}const i=r.value.substring(0,e)+n+r.value.substring(t);r.value=i,L(),s.isCollaborative&&typeof m<"u"?r.dispatchEvent(new Event("input",{bubbles:!0})):Y()}catch(n){console.error("AI edit error:",n),alert("Failed to apply AI edit: "+n.message)}finally{g&&g.classList.remove("loading")}},oe=async()=>{if(O||s.isCollaborative)return;const e=r.value.trim();if(e)try{const{result:t}=await te({type:"summary",content:e});if(!t)return;O=!0,ne(t.trim())}catch(t){console.error("AI title error:",t)}},ne=e=>{if(!e)return;const t=e.replace(/\s+/g," ").replace(/[#/\\]/g,"").trim();if(!t)return;const o=t.slice(0,80);if(l[o]&&o!==s.title){let n=2,i=`${o} (${n})`;for(;l[i];)n+=1,i=`${o} (${n})`;return ne(i)}if(!l[s.title])return;const a=l[s.title];delete l[s.title],l[o]={...a,lockedTitle:!0},s.title=o,s.lockedTitle=!0,Z(),$(l),F(o)};r&&(r.addEventListener("mouseup",M),r.addEventListener("keyup",M),r.addEventListener("input",()=>{const e=l[s.title];!(s.lockedTitle||e&&e.lockedTitle)&&!O&&r.value.trim().length>40&&oe()}));window.applyAiEdit=Ee;window.hideAiToolbar=L;window.generateAiTitle=oe;window.createNewCollaborativeNote=ke;window.shareCurrentNote=Ie;ae($,F);console.log("App initialized");
